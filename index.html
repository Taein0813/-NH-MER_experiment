<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>음악 감정 평가 실험</title>

  <!-- jsPsych core -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet"/>

  <!-- plugins -->
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>

  <style>
    body {
      max-width: 1100px;
      margin: 0 auto;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
    }

    h1.main-title {
      text-align: center;
      margin: 18px 8px 8px;
      font-size: 26px;
      line-height: 1.3;
    }

    /* ✅ 제출 완료 화면 중앙 정렬 */
    .center-screen {
      min-height: 70vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      line-height: 1.8;
    }

    /* (이하 기존 스타일 그대로) */
    fieldset {
      margin-bottom: 20px;
      border: 1px dashed #a0a0a0;
      padding: 12px 18px;
      border-radius: 6px;
      background: #fafafa;
    }

    .trial-layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      margin-top: 12px;
    }

    .left-pane { flex: 1.2; }
    .right-pane { flex: 1; }

    .top-instruction {
      text-align: center;
      margin-bottom: 10px;
      border: 1px dashed #ccc;
      padding: 10px;
      background: #fafafa;
      border-radius: 6px;
    }

    .slider-row { margin: 8px 0 18px 0; font-size: 13px; }

    .slider-wrap { position: relative; width: 100%; }
    .slider-wrap input[type="range"] { width: 100%; }

    .slider-wrap .mid-tick {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 130%;
      background: #777;
      pointer-events: none;
    }

    .slider-label-line {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 4px;
    }

    .progress-text {
      text-align: right;
      font-size: 13px;
      margin: 6px 4px;
      color: #555;
    }
  </style>
</head>

<body>
  <div id="jspsych-target"></div>

  <script>
    const SUBMIT_URL =
      "https://script.google.com/macros/s/AKfycbwAx7SoUNU8UWgo4UsFnyaZ_myc3lO8JQRlY7qFuk2r6HTFpD32_8IWiZwhcaNOVOPC2Q/exec";

    const jsPsych = initJsPsych({
      display_element: "jspsych-target",
      on_finish: function () {
        const csv = jsPsych.data.get().csv();

        const now = new Date();
        fetch(SUBMIT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            subject_id: subject_id,
            csv: csv,
            submitted_at: now.toLocaleString("ko-KR", { timeZone: "Asia/Seoul" }),
            submitted_iso: now.toISOString(),
          }),
        });
      },
    });

    const subject_id = jsPsych.randomization.randomID(10);
    jsPsych.data.addProperties({ subject_id });

    /* ---------------- 종료 버튼 화면 ---------------- */
    const outro = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2>실험이 완료되었습니다.</h2>
        <p>종료 버튼을 누르면 응답이 저장됩니다.</p>
      `,
      choices: ["종료 (꼭 눌러주세요)"],
    };

    /* ✅ 제출 완료 중앙 메시지 */
    const submitted_screen = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="center-screen">
          <div>
            응답이 제출되었습니다.<br>
            실험에 참여해 주셔서 감사합니다!
          </div>
        </div>
      `,
      choices: [],
      trial_duration: 3000
    };

    /* (앞부분 start_screen / consent / demographics / song_procedure는
       네가 준 코드 그대로 유지하면 됨) */

    jsPsych.run([
      start_screen,
      consent_human,
      consent_payment,
      demographics,
      song_procedure,
      outro,
      submitted_screen   // ✅ 핵심
    ]);
  </script>
</body>
</html>
