<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>음악 감정 평가 실험</title>

  <!-- jsPsych core -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" />

  <!-- plugins -->
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>

  <style>
    body {
      max-width: 1100px;
      margin: 0 auto;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
    }
    h1.main-title {
      text-align: center;
      margin: 18px 8px 8px;
      font-size: 26px;
      line-height: 1.3;
    }
    fieldset {
      margin-bottom: 20px;
      border: 1px dashed #a0a0a0;
      padding: 12px 18px;
      border-radius: 6px;
      background: #fafafa;
    }
    legend {
      font-weight: 600;
      padding: 0 6px;
    }
    .trial-layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      margin-top: 12px;
    }
    .left-pane { flex: 1.2; text-align: left; }
    .right-pane { flex: 1; }

    .top-instruction {
      text-align: center;
      margin-bottom: 10px;
      border: 1px dashed #ccc;
      padding: 10px;
      background: #fafafa;
      border-radius: 6px;
    }

    .progress-text {
      text-align: right;
      font-size: 13px;
      margin: 6px 4px 4px;
      color: #555;
    }

    /* PDF box */
    .pdf-box {
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
      border-radius: 6px;
      overflow: hidden;
      margin: 12px 0 16px;
    }
    .pdf-box iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .consent-text {
      font-size: 13px;
      margin-bottom: 8px;
      line-height: 1.6;
    }
    .consent-section-title {
      font-weight: 600;
      margin: 10px 0 4px;
      font-size: 14px;
    }
    .consent-input-row { margin: 6px 0; font-size: 13px; }
    .consent-input-row label { min-width: 190px; display: inline-block; }
    .consent-input-row input[type="text"] {
      width: 60%; max-width: 360px; padding: 4px 6px; font-size: 13px;
    }

    /* 슬라이더 */
    .slider-row { margin: 8px 0 18px; font-size: 13px; }
    .slider-label-line {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 4px;
    }

    /* 가운데 눈금(50) 표시 */
    .slider-wrap {
      position: relative;
      width: 100%;
      margin-top: 6px;
    }
    .slider-wrap input[type="range"] {
      width: 100%;
      margin: 0;
    }
    .slider-wrap .mid-tick {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 130%;
      background: #666;
      pointer-events: none;
    }

    @media (max-width: 900px) {
      .trial-layout { flex-direction: column; }
      .left-pane, .right-pane { width: 100%; }
      .consent-input-row label { display: block; margin-bottom: 3px; }
      .consent-input-row input[type="text"] { width: 100%; max-width: 100%; }
    }
  </style>
</head>

<body>
  <div id="jspsych-target"></div>

<script>
/* -----------------------------
   Google Sheet WebApp URL
------------------------------ */
const SUBMIT_URL =
  "https://script.google.com/macros/s/AKfycbwAx7SoUNU8UWgo4UsFnyaZ_myc3lO8JQRlY7qFuk2r6HTFpD32_8IWiZwhcaNOVOPC2Q/exec";

/* -----------------------------
   jsPsych 초기화
------------------------------ */
const jsPsych = initJsPsych({
  display_element: "jspsych-target",
  on_finish: function () {
    const csv = jsPsych.data.get().csv();

    fetch(SUBMIT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ subject_id: subject_id, csv: csv }),
    });
  }
});

const subject_id = jsPsych.randomization.randomID(10);
jsPsych.data.addProperties({ subject_id });

/* -----------------------------
   0. 시작 안내 화면
------------------------------ */
const start_screen = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h1 class="main-title">음악 감정 평가 실험 안내</h1>
    <p style="text-align:left; line-height:1.7;">
      이 실험에서는 짧은 음악을 듣고 감정과 Valence/Arousal을 평가하게 됩니다.<br><br>
      실험을 시작하기 전 아래 두 동의서를 확인하고 동의해 주셔야 합니다:
    </p>
    <ul style="text-align:left; line-height:1.7;">
      <li>① 인간대상 연구피험자 동의서</li>
      <li>② (사례비 지급 등)을 위한 개인정보 수집 및 활용 동의서</li>
    </ul>
    <p style="text-align:left; line-height:1.7;">
      두 동의서 모두에 동의해야 실험에 참여하실 수 있습니다.
    </p>
  `,
  choices: ["동의서 확인 시작"]
};

/* -----------------------------
   1. 동의서 1 (인간대상 연구)
------------------------------ */
const consent_human = {
  type: jsPsychSurveyHtmlForm,
  preamble: `
    <h1 class="main-title">인간대상 연구피험자 동의서</h1>
    <p class="consent-text">PDF 파일을 끝까지 읽어주세요.</p>
    <div class="pdf-box"><iframe src="consent_human.pdf"></iframe></div>
  `,
  html: `
    <div class="consent-section-title">[개인정보 수집 동의]</div>
    <label><input type="radio" name="human_main_collect" value="동의합니다" required> 동의합니다</label><br>
    <label><input type="radio" name="human_main_collect" value="동의하지 않습니다"> 동의하지 않습니다</label>

    <div class="consent-section-title" style="margin-top:16px;">서명</div>
    <div class="consent-input-row">
      <label>성명 :</label>
      <input type="text" name="human_name" required>
    </div>
  `,
  button_label: "다음 (사례비 동의서)",
  on_finish: function(data){
    if (data.response.human_main_collect === "동의하지 않습니다") {
      jsPsych.endExperiment("동의하지 않으셔서 실험이 종료됩니다.");
    }
  }
};

/* -----------------------------
   2. 동의서 2 (사례비)
------------------------------ */
const consent_payment = {
  type: jsPsychSurveyHtmlForm,
  preamble: `
    <h1 class="main-title">사례비 지급 동의서</h1>
    <div class="pdf-box"><iframe src="consent_payment.pdf"></iframe></div>
  `,
  html: `
    <div class="consent-section-title">[개인정보 수집 동의]</div>
    <label><input type="radio" name="payment_main_consent" value="동의합니다" required> 동의합니다</label><br>
    <label><input type="radio" name="payment_main_consent" value="동의하지 않습니다"> 동의하지 않습니다</label>

    <div class="consent-section-title" style="margin-top:16px;">서명</div>
    <div class="consent-input-row">
      <label>성명 :</label><input type="text" name="pay_name" required>
    </div>
  `,
  button_label: "다음 (기초 정보 입력)",
  on_finish: function(data){
    if (data.response.payment_main_consent === "동의하지 않습니다") {
      jsPsych.endExperiment("동의하지 않으셔서 실험이 종료됩니다.");
    }
  }
};

/* -----------------------------
   3. 기초정보
------------------------------ */
const demographics = {
  type: jsPsychSurveyHtmlForm,
  preamble: `<h1 class="main-title">기초 정보 입력</h1>`,
  html: `
    <div class="consent-input-row">
      <label>생물학적 성별 :</label>
      <label><input type="radio" name="bio_sex" value="남성" required> 남성</label>
      <label><input type="radio" name="bio_sex" value="여성"> 여성</label>
    </div>

    <div class="consent-input-row">
      <label>만 나이 :</label>
      <input type="text" name="age" required>
    </div>

    <div class="consent-input-row">
      <label>음악 전공 여부 :</label>
      <label><input type="radio" name="major_status" value="전공자" required> 전공자</label>
      <label><input type="radio" name="major_status" value="비전공자"> 비전공자</label>
    </div>
  `,
  button_label: "음악 실험 시작",
  on_finish: function(data){
    jsPsych.data.addProperties(data.response);
  }
};

/* -----------------------------
   4. 자극 목록 준비 (70)
------------------------------ */
const emotionGroups = ["calm","cheerful","dreamy","energetic","love","sad","tense"];
let stimuli = [];
emotionGroups.forEach(em=>{
  ["C","S"].forEach(tag=>{
    for(let i=1;i<=5;i++){
      stimuli.push({
        file:`stims/${em}_${tag}${String(i).padStart(2,"0")}.mp3`,
        base_emotion: em
      });
    }
  })
});
stimuli = jsPsych.randomization.shuffle(stimuli);

/* -----------------------------
   5. 슬라이더 감정 항목
------------------------------ */
const sliderEmotions = [
  { code:"cheerful", label:"즐거운 (cheerful)" },
  { code:"energetic", label:"에너지가 넘치는 (energetic)" },
  { code:"in_love", label:"사랑에 빠진 (in love)" },
  { code:"dreamy", label:"꿈꾸는 듯한 (dreamy)" },
  { code:"calm", label:"평온한 (calm)" },
  { code:"sad", label:"슬픈 (sad)" },
  { code:"tense", label:"불안한 (tense)" }
];

/* -----------------------------
   6. 한 곡 trial
------------------------------ */
const song_trial = {
  type: jsPsychSurveyHtmlForm,
  html: function(){
    const file = jsPsych.timelineVariable("file");
    const idx  = jsPsych.timelineVariable("seq");

    let sliderHTML = "";
    sliderEmotions.forEach(em=>{
      sliderHTML += `
        <div class="slider-row">
          <div><strong>${em.label}</strong></div>
          <div class="slider-wrap">
            <input type="range" name="${em.code}" min="0" max="100" value="0">
            <div class="mid-tick"></div>
          </div>
          <div class="slider-label-line">
            <span>0</span><span>100</span>
          </div>
        </div>
      `;
    });

    const valence = `
      <div class="slider-row">
        <div><strong>Valence (정서가)</strong></div>
        <div class="slider-wrap">
          <input type="range" name="valence" min="0" max="100" value="50">
          <div class="mid-tick"></div>
        </div>
        <div class="slider-label-line">
          <span>0 (부정)</span><span>100 (긍정)</span>
        </div>
      </div>
    `;

    const arousal = `
      <div class="slider-row">
        <div><strong>Arousal (각성도)</strong></div>
        <div class="slider-wrap">
          <input type="range" name="arousal" min="0" max="100" value="50">
          <div class="mid-tick"></div>
        </div>
        <div class="slider-label-line">
          <span>0 (차분)</span><span>100 (각성)</span>
        </div>
      </div>
    `;

    return `
      <div class="progress-text">곡 ${idx} / ${stimuli.length}</div>

      <div class="top-instruction">
        <button type="button" class="jspsych-btn"
                onclick="document.getElementById('audio${idx}').play()">
          Play
        </button>
        <audio id="audio${idx}" src="${file}" preload="auto"></audio>
      </div>

      <div class="trial-layout">
        <div class="left-pane">
          <fieldset>
            <legend>감정 강도</legend>
            ${sliderHTML}
          </fieldset>
        </div>

        <div class="right-pane">
          <fieldset>
            <legend>Valence</legend>
            ${valence}
          </fieldset>
          <fieldset>
            <legend>Arousal</legend>
            ${arousal}
          </fieldset>
        </div>
      </div>
    `;
  },
  data: {
    file: jsPsych.timelineVariable("file"),
    base_emotion: jsPsych.timelineVariable("base_emotion")
  },
  on_finish: function(data){
    const resp = data.response || {};
    sliderEmotions.forEach(em=>{
      data[em.code] = Number(resp[em.code]);
    });
    data.valence = Number(resp.valence);
    data.arousal = Number(resp.arousal);
  }
};

const song_procedure = {
  timeline:[song_trial],
  timeline_variables: stimuli.map((s,idx)=>({...s, seq:idx+1})),
  randomize_order:false
};

/* -----------------------------
   7. 종료 화면
------------------------------ */
const outro = {
  type: jsPsychHtmlButtonResponse,
  stimulus:`<h2>실험이 종료되었습니다!</h2><p>참여해 주셔서 감사합니다.</p>`,
  choices:["종료"]
};

/* -----------------------------
   8. 실행
------------------------------ */
jsPsych.run([
  start_screen,
  consent_human,
  consent_payment,
  demographics,
  song_procedure,
  outro
]);

</script>
</body>
</html>
